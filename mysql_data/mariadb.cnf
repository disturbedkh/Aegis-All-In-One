[client-server]
socket = /run/mysqld/mysqld.sock

[mariadbd]
# =============================================================================
#                    AEGIS ALL-IN-ONE MARIADB CONFIGURATION
#                    Optimized for Pokemon Mapping Projects
# =============================================================================
#
# WHAT IS THIS FILE?
# ------------------
# This file controls how MariaDB (the database) behaves. Think of the database
# as a giant organized filing cabinet that stores all your Pokemon data:
# spawns, gyms, pokestops, accounts, routes, and more.
#
# These settings tune how fast the database works, how much memory it uses,
# and how safe your data is. The defaults here work for most setups, but you
# may need to adjust some values based on your server's hardware.
#
# WHEN SHOULD I CHANGE THESE SETTINGS?
# ------------------------------------
# - If your server has more or less RAM than 8GB
# - If you're running on an SSD vs a regular hard drive (HDD)
# - If you have more or fewer CPU cores
# - If you're experiencing slow map loading or database errors
#
# HOW TO APPLY CHANGES?
# --------------------
# After editing this file, restart the database container:
#   docker compose restart database
#
# =============================================================================


# =============================================================================
# SECTION 1: CONNECTION SETTINGS
# =============================================================================
# These settings control how applications connect to the database.
# Think of it like a restaurant - these settings control how many customers
# (connections) can be seated at once and how long they can stay.
# =============================================================================

# MAX CONNECTIONS
# ---------------
# How many applications can connect to the database at the same time.
# 
# In Aegis, these services connect to the database:
#   - Golbat (processes Pokemon data)
#   - Dragonite (scanner controller) 
#   - ReactMap (the map you see in your browser)
#   - Koji (manages your scanning areas)
#   - Poracle (Discord/Telegram alerts)
#   - phpMyAdmin (database management tool)
#
# 500 connections is MORE than enough for most setups.
# Each unused connection wastes about 256KB of memory.
#
# DON'T CHANGE THIS unless you're running a massive multi-server setup.
max_connections = 500

# MAX ALLOWED PACKET
# ------------------
# The largest single piece of data that can be sent to/from the database.
# 128MB allows for large Pokemon data imports and quest information.
#
# Think of it like the maximum package size a delivery truck can carry.
# If you see errors about "packet too large", increase this value.
max_allowed_packet = 128M

# TIMEOUT SETTINGS
# ----------------
# How long a connection can sit idle before being disconnected.
# 28800 seconds = 8 hours
#
# This is set high because mapping applications maintain persistent 
# connections and shouldn't be disconnected while running.
#
# wait_timeout: Regular connections (like from Golbat)
# interactive_timeout: Interactive sessions (like phpMyAdmin)
wait_timeout = 28800
interactive_timeout = 28800

# Network timeouts for reading/writing data
# 120 seconds should handle even slow network operations
net_read_timeout = 120
net_write_timeout = 120

# THREAD SETTINGS
# ---------------
# thread_stack: Memory for each thread's internal operations
# thread_cache_size: Reuse threads instead of creating new ones (faster)
thread_stack = 512K
thread_cache_size = 64

# SKIP DNS LOOKUPS
# ----------------
# These make connections faster by skipping unnecessary network lookups.
# Since all our services connect using container names (like "database"),
# we don't need DNS resolution.
#
# LEAVE THESE ENABLED - they significantly speed up connections.
skip-host-cache
skip-name-resolve

# EVENT SCHEDULER
# ---------------
# Allows the database to run scheduled cleanup tasks automatically.
# This helps keep the Pokemon table from growing infinitely.
#
# LEAVE THIS ON - Golbat uses it to clean up old Pokemon spawns.
event_scheduler = on


# =============================================================================
# SECTION 2: INNODB BUFFER POOL (MOST IMPORTANT SETTING!)
# =============================================================================
# The buffer pool is like the database's "working memory" or RAM.
# Data that's frequently accessed is kept here for FAST retrieval.
# 
# BIGGER = FASTER (up to a point)
# 
# If the buffer pool is too small, the database constantly reads from disk
# (slow). If it's too big, you won't have RAM left for Golbat and other
# services (also bad).
# =============================================================================

# BUFFER POOL SIZE
# ----------------
# THIS IS THE MOST IMPACTFUL SETTING FOR PERFORMANCE!
#
# RULE OF THUMB:
# - If database is the ONLY thing on the server: Use 50-70% of RAM
# - If sharing with Golbat/Dragonite (typical): Use 25-40% of RAM
#
# QUICK REFERENCE TABLE:
# ┌─────────────┬────────────────────────────────────┐
# │ Your RAM    │ Recommended innodb_buffer_pool_size│
# ├─────────────┼────────────────────────────────────┤
# │ 4 GB        │ 1G                                 │
# │ 8 GB        │ 2G - 3G                            │
# │ 16 GB       │ 4G - 6G                            │
# │ 32 GB       │ 8G - 12G                           │
# │ 64 GB       │ 16G - 24G                          │
# └─────────────┴────────────────────────────────────┘
#
# HOW TO CHECK YOUR RAM:
#   Run this command: free -h
#   Look at the "total" column under "Mem:"
#
# SYMPTOMS OF TOO SMALL BUFFER POOL:
# - Slow map loading
# - High disk activity (constant hard drive noise/LED blinking)
# - Queries taking seconds instead of milliseconds
#
# SYMPTOMS OF TOO LARGE BUFFER POOL:
# - Server becomes unresponsive
# - Other services crash with "out of memory" errors
# - System starts using swap (very slow)
#
# DEFAULT: 4G (good for 8-16GB RAM servers)
innodb_buffer_pool_size = 4G

# BUFFER POOL INSTANCES
# ---------------------
# Splits the buffer pool into separate chunks for better performance
# when multiple queries run at the same time.
#
# RULE: 1 instance per 1GB of buffer pool, maximum of 8
#
# Examples:
#   - 2G buffer pool = 2 instances
#   - 4G buffer pool = 4 instances  
#   - 8G+ buffer pool = 8 instances (max)
#
# DEFAULT: 4 (matches 4G buffer pool)
innodb_buffer_pool_instances = 4


# =============================================================================
# SECTION 3: INNODB LOG FILES (Transaction Logs / Redo Logs)
# =============================================================================
# These logs record all changes before they're written to the actual data.
# Think of it like a "receipt" or "journal" of everything that happened.
# 
# If the database crashes, these logs help recover your data.
# =============================================================================

# LOG FILE SIZE
# -------------
# Size of each transaction log file.
#
# BIGGER logs = Better write performance, but SLOWER crash recovery
# SMALLER logs = Faster crash recovery, but slightly slower writes
#
# For mapping: 512M is a good balance. You want fast recovery if Docker
# restarts or your server reboots.
#
# If you're doing MASSIVE imports and see "log file too small" warnings,
# you can increase to 1G, but recovery will take longer.
innodb_log_file_size = 512M

# Number of log files (512M x 2 = 1GB total log space)
innodb_log_files_in_group = 2

# LOG BUFFER SIZE
# ---------------
# Memory buffer for log entries before writing to disk.
# 64M is plenty for mapping workloads with many small writes.
innodb_log_buffer_size = 64M


# =============================================================================
# SECTION 4: DISK I/O SETTINGS (Reading and Writing Speed)
# =============================================================================
# These settings control how the database reads from and writes to your
# storage device (hard drive or SSD).
#
# IMPORTANT: SSDs and HDDs need VERY different settings!
# =============================================================================

# I/O THREADS
# -----------
# How many background workers read/write data simultaneously.
# More threads = more parallel operations = faster on multi-core CPUs.
#
# RULE: About half your CPU cores for each type
#
# ┌─────────────┬──────────────────────────────────────────────┐
# │ CPU Cores   │ Recommended read/write/purge threads (each)  │
# ├─────────────┼──────────────────────────────────────────────┤
# │ 2 cores     │ 1 or 2                                       │
# │ 4 cores     │ 2                                            │
# │ 8 cores     │ 4                                            │
# │ 16 cores    │ 8                                            │
# └─────────────┴──────────────────────────────────────────────┘
#
# HOW TO CHECK YOUR CPU CORES:
#   Run this command: nproc
#
# DEFAULT: 4 each (good for 8-core CPUs, which are common)
innodb_read_io_threads = 4
innodb_write_io_threads = 4
innodb_purge_threads = 4

# I/O CAPACITY
# ------------
# How many I/O operations per second (IOPS) the database can use for
# background tasks like flushing data to disk.
#
# THIS DEPENDS ON YOUR STORAGE TYPE:
#
# ┌──────────────────┬─────────────────┬──────────────────────┐
# │ Storage Type     │ innodb_io_capacity│ innodb_io_capacity_max│
# ├──────────────────┼─────────────────┼──────────────────────┤
# │ Old HDD (5400rpm)│ 100             │ 200                  │
# │ Fast HDD (7200rpm)│ 150-200         │ 400                  │
# │ SATA SSD         │ 1000-2000       │ 4000                 │
# │ NVMe SSD         │ 4000-10000      │ 20000                │
# │ Cloud/VPS (varies)│ 500-2000        │ 2000-4000            │
# └──────────────────┴─────────────────┴──────────────────────┘
#
# NOT SURE WHAT YOU HAVE?
# - If your server is from a cloud provider (AWS, DigitalOcean, etc.),
#   it's likely SSD. Use the SATA SSD values.
# - If it's an old physical server, it might be HDD.
# - Modern laptops/desktops usually have SSDs.
#
# SYMPTOMS OF WRONG VALUES:
# - Too HIGH on HDD: Disk becomes overwhelmed, system freezes
# - Too LOW on SSD: Not using your fast storage's potential
#
# DEFAULT: 1000/4000 (good for typical SSDs)
innodb_io_capacity = 1000
innodb_io_capacity_max = 4000


# =============================================================================
# SECTION 5: DATA SAFETY vs PERFORMANCE (Important Trade-off!)
# =============================================================================
# These settings balance DATA SAFETY against SPEED.
# 
# Safer settings = Slower, but your data survives crashes
# Faster settings = Quicker, but you might lose recent data if power goes out
#
# For Pokemon mapping, losing a few seconds of spawn data is annoying but
# recoverable (Pokemon will spawn again). Losing your account database or
# area configurations would be much worse.
# =============================================================================

# FLUSH LOG AT TRANSACTION COMMIT (CRITICAL SETTING!)
# ---------------------------------------------------
# When should changes be written to disk?
#
# ┌───────┬────────────────────────────────────────────────────────────────┐
# │ Value │ What it means                                                  │
# ├───────┼────────────────────────────────────────────────────────────────┤
# │   0   │ DANGEROUS! Writes every 1 second. If power goes out, you lose │
# │       │ up to 1 second of data. Fastest, but NOT recommended.         │
# ├───────┼────────────────────────────────────────────────────────────────┤
# │   1   │ SAFEST! Every single change is immediately saved to disk.     │
# │       │ Slowest, but zero data loss on crash. Good for banks.         │
# ├───────┼────────────────────────────────────────────────────────────────┤
# │   2   │ BALANCED (RECOMMENDED FOR MAPPING)                            │
# │       │ Changes saved to operating system cache immediately,          │
# │       │ then written to disk every second.                            │
# │       │ Fast, and only lose ~1 second of data if HARDWARE fails.      │
# │       │ Software crashes/restarts won't lose data.                    │
# └───────┴────────────────────────────────────────────────────────────────┘
#
# WHY VALUE 2 IS RECOMMENDED:
# - Docker restart? No data loss.
# - Service crash? No data loss.
# - Server reboot? No data loss.
# - Power outage? Lose maybe 1 second (very rare, and Pokemon respawn anyway)
#
# DEFAULT: 2 (good balance for mapping)
innodb_flush_log_at_trx_commit = 2

# FLUSH METHOD
# ------------
# How data is written to disk.
# O_DIRECT tells the database to bypass the operating system's cache
# and write directly to disk. This prevents "double caching" 
# (data cached in both database AND OS, wasting RAM).
#
# LEAVE THIS AS O_DIRECT unless you have problems.
innodb_flush_method = O_DIRECT

# DOUBLEWRITE BUFFER
# ------------------
# Extra safety feature that writes data twice to prevent corruption
# if power fails mid-write (called "torn pages").
#
# 1 = ON (safer, slightly slower)
# 0 = OFF (faster, tiny risk of corruption on power failure)
#
# For mapping: OFF is acceptable because:
# - Pokemon data can be re-scanned
# - Power failures are rare
# - The performance gain is worth the tiny risk
#
# If you're running critical data or have unreliable power, set to 1.
innodb_doublewrite = 0

# LOCK WAIT TIMEOUT
# -----------------
# How long (in seconds) a query waits for another query to finish
# when they're trying to modify the same data.
#
# 15 seconds is reasonable. If you see "lock wait timeout" errors
# frequently, you can increase this, but it might indicate a bigger issue.
innodb_lock_wait_timeout = 15


# =============================================================================
# SECTION 6: UNDO LOGS (Rolling Back Changes)
# =============================================================================
# Undo logs let the database "undo" changes if something goes wrong.
# They also let multiple users see consistent data while others are writing.
#
# You generally don't need to change these.
# =============================================================================

# Automatically shrink undo logs when they get too big
innodb_undo_log_truncate = 1

# Number of separate undo tablespaces (files)
innodb_undo_tablespaces = 4

# Maximum size before truncation happens
innodb_max_undo_log_size = 1G

# ADAPTIVE HASH INDEX
# -------------------
# Automatically creates shortcuts (hash indexes) for frequently accessed data.
# Great for looking up Pokemon by ID, gym by ID, etc.
#
# LEAVE THIS ON - it helps with the types of queries mapping uses.
innodb_adaptive_hash_index = ON


# =============================================================================
# SECTION 7: TEMPORARY TABLES & SORTING
# =============================================================================
# When you ask for data "sorted by distance" or "grouped by Pokemon ID",
# the database might need to create temporary work areas.
#
# These settings control how big those work areas can be.
# =============================================================================

# TEMPORARY TABLE SIZE
# --------------------
# Maximum size for temporary tables created in memory.
# If a temp table exceeds this, it spills to disk (slower).
#
# Both values MUST match! (MySQL quirk)
#
# 256M is good for complex map queries with many Pokemon.
# Increase if you see slow queries and lots of "Created_tmp_disk_tables".
tmp_table_size = 256M
max_heap_table_size = 256M

# SORT AND JOIN BUFFERS
# ---------------------
# Memory allocated for sorting and joining data.
# These are per-connection, so don't go crazy (4M x 500 connections = 2GB!)
#
# For mapping queries, these defaults work well.
sort_buffer_size = 4M
join_buffer_size = 4M
read_buffer_size = 2M
read_rnd_buffer_size = 2M


# =============================================================================
# SECTION 8: TABLE CACHE
# =============================================================================
# When you access a table, the database needs to "open" it.
# Caching open tables avoids reopening them repeatedly.
# =============================================================================

# TABLE OPEN CACHE
# ----------------
# How many tables to keep open at once.
# 
# Aegis has about 20 tables across all databases.
# With 500 connections, we want: 500 * 2 = 1000 minimum
# 2000 gives us headroom for growth.
table_open_cache = 2000

# TABLE DEFINITION CACHE  
# ----------------------
# Caches table structure information (columns, indexes, etc.)
table_definition_cache = 1000

# OPEN FILES LIMIT
# ----------------
# Maximum files the database can have open.
# Must be higher than table_open_cache.
open_files_limit = 65535


# =============================================================================
# SECTION 9: BINARY LOGGING (OPTIONAL - For Backups/Replication)
# =============================================================================
# Binary logs record ALL changes to the database.
# Used for:
# - Point-in-time recovery (restore to any moment in time)
# - Replication (copying data to another server)
#
# DISABLED BY DEFAULT because:
# - Uses extra disk space
# - Most small setups don't need it
# - Pokemon data can be re-scanned if lost
#
# UNCOMMENT THESE LINES if you want binary logging:
# =============================================================================

# log_bin = mysql-bin
# binlog_format = ROW
# max_binlog_size = 100M

# How long to keep binary logs (in seconds)
# 259200 seconds = 3 days
binlog_expire_logs_seconds = 259200


# =============================================================================
# SECTION 10: SLOW QUERY LOG (DEBUGGING TOOL)
# =============================================================================
# Logs queries that take too long - helpful for finding performance problems.
#
# DISABLED BY DEFAULT because it creates extra disk writes.
#
# TO ENABLE: Uncomment the lines below, then check /var/log/mysql/slow.log
# =============================================================================

# slow_query_log = 1
# slow_query_log_file = /var/log/mysql/slow.log
# long_query_time = 2
# log_queries_not_using_indexes = 0


# =============================================================================
# SECTION 11: CHARACTER SET
# =============================================================================
# How text is stored. UTF8MB4 supports ALL characters including:
# - Pokemon names in any language (日本語, 한국어, etc.)
# - Emoji in Pokemon nicknames
# - Special characters
#
# DON'T CHANGE THIS - it's the modern standard.
# =============================================================================

character-set-server = utf8mb4
collation-server = utf8mb4_unicode_ci


# =============================================================================
# INCLUDE ADDITIONAL CONFIG FILES
# =============================================================================
# These lines load any extra config files from system directories.
# Usually empty, but allows for system-level overrides.
# =============================================================================

!includedir /etc/mysql/mariadb.conf.d/
!includedir /etc/mysql/conf.d/


# =============================================================================
#                           QUICK TROUBLESHOOTING GUIDE
# =============================================================================
#
# PROBLEM: Map loads slowly, database queries take forever
# LIKELY CAUSE: Buffer pool too small
# FIX: Increase innodb_buffer_pool_size (see Section 2)
#
# PROBLEM: Server runs out of memory, services crash
# LIKELY CAUSE: Buffer pool too big
# FIX: Decrease innodb_buffer_pool_size
#
# PROBLEM: "Too many connections" error
# LIKELY CAUSE: Connection leak in application (rare)
# FIX: Restart the service causing the leak, or increase max_connections
#
# PROBLEM: "Lock wait timeout exceeded" errors
# LIKELY CAUSE: Long-running queries blocking each other
# FIX: Increase innodb_lock_wait_timeout, or optimize your queries
#
# PROBLEM: High disk usage, constant disk activity
# LIKELY CAUSE: Buffer pool too small (data constantly read from disk)
# FIX: Increase innodb_buffer_pool_size
#
# PROBLEM: Slow writes, data taking long to save
# LIKELY CAUSE: innodb_io_capacity too low for your storage
# FIX: Increase innodb_io_capacity (see Section 4)
#
# PROBLEM: Database won't start after changing settings
# LIKELY CAUSE: Invalid configuration value
# FIX: Check Docker logs: docker logs database
#      Revert your changes and try smaller adjustments
#
# =============================================================================
#                              NEED MORE HELP?
# =============================================================================
#
# Join the Pokemod Discord: https://discord.gg/pokemod
# Check the Unown# Discord: https://discord.gg/Vjze47qchG
#
# =============================================================================
