# AI Assistant Rules for Aegis AIO

> Follow these guidelines when working on the Aegis AIO project.

---

## General Principles

### Before Making Changes

1. **Read relevant files first** - Don't modify without understanding
2. **Check container status** - `docker compose ps` before Docker operations
3. **Verify current state** - Use Shellder dashboard or check.sh
4. **Preserve working configs** - Backup before editing critical files

### During Changes

1. **Use existing patterns** - Follow codebase conventions
2. **Make incremental changes** - Don't change everything at once
3. **Use Shellder scripts** - Prefer ./shellder.sh over raw commands
4. **Test after changes** - Verify services still work

### After Changes

1. **Update CHANGELOG.md** - Document significant changes
2. **Update COLLABORATORS.md** - Note what you worked on
3. **Verify functionality** - Check affected services
4. **Commit with good messages** - Be descriptive

---

## File Operations

### Never Modify Directly

| Files/Directories | Reason |
|-------------------|--------|
| `mysql_data/*` | Live database files - will corrupt |
| `*.db` (SQLite) | Active databases |
| `node_modules/` | Auto-generated by npm |
| `.venv/` | Python virtual environment |
| `*-default.*` | Template files (copy, don't edit) |

### Always Backup First

| Files | Impact of Mistakes |
|-------|-------------------|
| `.env` | Stack won't start |
| `docker-compose.yaml` | Services misconfigured |
| `unown/*_config.toml` | Scanners fail |
| `reactmap/local.json` | Map broken |

### Safe to Modify

| Files | When |
|-------|------|
| `AI/*.md` | Updating documentation |
| `wiki/*.md` | Improving docs |
| `Shellder/*.sh` | Fixing scripts |
| `.cursorrules` | AI behavior |
| `.gitignore` | Git patterns |

---

## File Ownership

### Critical Rule

**ALWAYS call `fix_file_ownership()` after writing files in shellder_service.py!**

```python
# After ANY file write:
with open(file_path, 'w') as f:
    f.write(content)
fix_file_ownership(file_path)  # <-- REQUIRED!
```

### Why This Matters

When Shellder runs with `sudo`, files get created owned by `root`. This locks users out of their own files and breaks Docker containers that need to write to volumes.

### Auto-Detection System

Shellder automatically detects the correct owner:

```python
uid, gid, username = get_aegis_owner()
# Returns the actual project owner, not root
```

Detection priority:
1. Owner of AEGIS_ROOT directory
2. SUDO_USER environment variable
3. PUID/PGID from .env
4. Fallback to uid 1000/1001

### PUID/PGID

- **Never hardcode** PUID=1000 or PGID=1000
- Let `auto_detect_and_fix_puid_pgid()` handle it on startup
- Different systems have different first-user UIDs (1000, 1001, 500, etc.)

---

## Docker Operations

### Commands to Use

```bash
docker compose up -d           # Start (detached)
docker compose down            # Stop all
docker compose restart <svc>   # Restart one service
docker compose logs -f <svc>   # Follow logs
docker compose ps              # Check status
```

### Commands to Avoid

```bash
docker-compose (hyphenated)    # Use space version
docker compose up              # Missing -d, blocks terminal
docker compose down -v         # Deletes volumes/data!
docker system prune -a         # May delete needed images
```

### Service Names

Use these exact names with docker compose:
- `database`, `dragonite`, `admin`, `golbat`, `rotom`
- `xilriws`, `reactmap`, `koji`, `pma`, `shellder`
- `grafana`, `victoriametrics`, `vmagent`

---

## Database Operations

### Safe Practices

```sql
-- Always use LIMIT
SELECT * FROM pokemon LIMIT 10;

-- Always specify database
USE golbat;

-- Read-only queries preferred
SELECT COUNT(*) FROM pokemon;
```

### Dangerous Operations

```sql
-- NEVER without WHERE clause
DELETE FROM pokemon;
UPDATE accounts SET banned=1;

-- NEVER in production
DROP TABLE pokemon;
TRUNCATE TABLE accounts;
```

### Available Databases

| Database | Safe Tables to Query |
|----------|---------------------|
| `golbat` | pokemon, gym, pokestop, raid |
| `dragonite` | pokemon_account, pokemon_worker |
| `reactmap` | users, session |
| `koji` | geofence, project |

---

## Configuration Guidelines

### .env File

- **Never commit** - Contains secrets
- **Match init/01.sql** - Database password must match
- **Use strong secrets** - 8+ characters minimum

### Docker Compose

- **Check depends_on** when adding services
- **Use internal networks** for service-to-service
- **Expose only needed ports**

### Scanner Configs (unown/*.toml)

- **Copy from *-default first** - Don't edit defaults
- **Match database credentials** with .env
- **Verify API secrets** match across services

---

## Security Rules

### Never Expose

- Port 3306 (MariaDB) - Internal only
- Docker socket - Read-only access only
- `.env` contents - Secrets stay secret

### Always Protect

- External endpoints - Use Nginx + auth
- Database credentials - Strong passwords
- API secrets - Unique per installation

### Recommended

- Enable fail2ban for SSH
- Use SSL certificates via Let's Encrypt
- Firewall all ports except needed (7070, 80, 443)

---

## Troubleshooting Guidelines

### Order of Investigation

1. **Check container status** - `docker compose ps`
2. **Read container logs** - `docker logs <container>`
3. **Check system resources** - Shellder dashboard or `htop`
4. **Verify configs** - `bash Shellder/check.sh`
5. **Check ports** - `netstat -tlnp | grep <port>`

### Common Issues

| Symptom | First Check |
|---------|-------------|
| Container won't start | `docker logs <container>` |
| Database connection failed | Credentials in .env vs config |
| Port already in use | `lsof -i :<port>` |
| Device not connecting | Port 7070 firewall, Rotom logs |
| Auth failures | Xilriws logs, proxy health |

### Use Shellder Tools

```bash
bash Shellder/check.sh        # Comprehensive validation
bash Shellder/logs.sh         # Log viewer
bash Shellder/dbsetup.sh      # Database maintenance
```

---

## Code Style

### Shell Scripts

- Use bash shebang: `#!/bin/bash`
- Quote variables: `"$VAR"` not `$VAR`
- Check command success: `if ! command; then`
- Use meaningful function names

### Python (shellder_service.py)

- Follow existing patterns in shellder_service.py
- Use Flask conventions with `@app.route()` decorators
- Handle exceptions properly with try/except
- Log with appropriate levels (debug, info, warning, error)
- **CRITICAL:** Always strip ANSI codes from Docker logs before regex parsing
- SQLite: Always set `busy_timeout` and use WAL mode for concurrent access

### JavaScript (script.js)

- **Search for existing functions before adding new ones** - duplicates silently override!
- **NEVER reassign global functions with wrappers** - this breaks onclick handlers!
  ```javascript
  // BAD - breaks the GUI completely:
  window.navigateTo = function(page) { originalNavigateTo(page); };
  // GOOD - modify the original function directly instead
  ```
- Use `async/await` with `fetchAPI()` for API calls
- Implement AbortController for cancellable requests
- Use `TextEncoder`/`TextDecoder` for base64 encoding (not deprecated escape/unescape)
- Check DevTools Network tab to verify actual API response field names
- When adding new pages: add to `titles` object AND add handler in `navigateTo()`

### CSS (style.css)

- Follow existing class naming conventions
- Use CSS variables for colors (defined at top of file)
- For flex items that should fill space: use `flex: 1` without `max-width`

### TOML/JSON Configs

- Nested TOML sections like `[db.dragonite]` create nested objects
- Navigate with optional chaining: `obj.db?.dragonite?.user`
- Don't use flat key access: `obj['db.dragonite']` won't work

### Documentation

- Use Markdown consistently
- Include code examples
- Keep tables aligned
- Update related docs together

---

## MCP/API Usage

### When Using AI Debug API

- Start with `/api/ai-debug/diagnose`
- Use LIMIT on SQL queries
- Check logs before and after changes
- File paths are relative to Aegis root

### When Using MCP Tools

- `shellder_diagnose` first for context
- `shellder_logs` for error investigation
- `shellder_docker` for container operations
- `shellder_sql` with read-only queries
